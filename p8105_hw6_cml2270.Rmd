---
title: "p8105_hw6_cml2270"
author: "Catherine Lucey"
date: "11/30/2021"
output: github_document
editor_options: 
  chunk_output_type: console
---

## Setup
Only done once, the setup code loads the necessary libraries and double checks that the working directory is correct. It also sets defaults for figure size with knitr, as well as a default theme and color scale for all ggplots.

```{r setup}
library(tidyverse)

getwd()

knitr::opts_chunk$set(
  fig.width = 10,
  fig.asp = .6,
  out.width = "90%"
)

theme_set(theme_minimal() + theme(legend.position = "bottom"))

options(
  ggplot2.continuous.colour = "viridis",
  ggplot2.continuous.fill = "viridis"
)

scale_colour_discrete = scale_colour_viridis_d
scale_fill_discrete = scale_fill_viridis_d
```

# Problem 1: Birthweight Data

Load and clean the data for regression analysis (i.e. convert numeric to factor where appropriate, check for missing data, etc.).

Propose a regression model for birthweight. This model may be based on a hypothesized structure for the factors that underlie birthweight, on a data-driven model-building process, or a combination of the two. Describe your modeling process and show a plot of model residuals against fitted values – use add_predictions and add_residuals in making this plot.

Compare your model to two others:

    One using length at birth and gestational age as predictors (main effects only)
    One using head circumference, length, sex, and all interactions (including the three-way interaction) between these

Make this comparison in terms of the cross-validated prediction error; use crossv_mc and functions in purrr as appropriate.

Note that although we expect your model to be reasonable, model building itself is not a main idea of the course and we don’t necessarily expect your model to be “optimal”.

```{r load_clean, error = TRUE}

birthweight_df =
  read_csv("birthweight.csv") %>% 
  drop_na() %>% 
  mutate(
    babysex = as.factor(babysex),
    malform = as.factor(malform),
    frace = as.factor(frace, levels = c("White", "Black", "Asian", "Puerto Rican", "Other", "Uknown")),
    frace = fct_relevel(frace, levels = c("White", "Black", "Asian", "Puerto Rican", "Other", "Uknown"))
  )


frace = factor(frace, levels = c("White", "Black", "Asian", "Puerto Rican", "Other", "Uknown")),
    mrace = factor(mrace, levels = c("White", "Black", "Asian", "Puerto Rican", "Other", "Uknown"))

```

#### EDA To Generate Hypotheses for a Model

Note that only three subjects had previously had live births, so for most subjects the `parity` variable is = 0. Similarly, no subject has a recorded previous low birthweight baby (`pnumlbw`), and no subjects have a recorded previous small for gestational age baby (`pnumgsa`).

```{r error = TRUE}

birthweight_df %>% 
  ggplot(aes(y = bwt, x = momage)) +
  geom_point() +
  geom_smooth()

birthweight_df %>% 
  ggplot(aes(y = bwt, x = menarche)) +
  geom_point() +
  geom_smooth()

birthweight_df %>% 
  ggplot(aes(y = bwt, x = ppwt, color = ppbmi)) +
  geom_point() +
  geom_smooth()

birthweight_df %>% 
  ggplot(aes(x = frace, y = bwt)) +
  geom_boxplot()

```


# Problem 2: Bootstrap Central Park Data

```{r load_data, message=FALSE}

weather_df = 
  rnoaa::meteo_pull_monitors(
    c("USW00094728"),
    var = c("PRCP", "TMIN", "TMAX"), 
    date_min = "2017-01-01",
    date_max = "2017-12-31") %>%
  mutate(
    name = recode(id, USW00094728 = "CentralPark_NY"),
    tmin = tmin / 10,
    tmax = tmax / 10) %>%
  select(name, id, everything())

```

```{r bstrap_model}

boot_sample = function(df){
  
  sample_frac(df, size = 1, replace = TRUE)
}

boot_strap_df = 
  tibble(
    bstrap_number = 1:5000, 
    bstrap_sample = rerun(5000, boot_sample(weather_df))
  )

bootstrap_results =
  boot_strap_df %>% 
  mutate(
   models = map(.x = bstrap_sample, ~lm(tmax ~ tmin, data = .x))
   )
  
beta_df =
  bootstrap_results %>%
  mutate(
    results = map(models, broom::tidy)
  ) %>% 
  select(bstrap_number, results) %>% 
  unnest(results) %>%
  pivot_wider(
    names_from = term,
    values_from = c(estimate, std.error, statistic, p.value)
  ) %>% 
  janitor::clean_names() %>% 
  mutate(
    log_b0b1 = log(estimate_intercept * estimate_tmin)
  )

confidence_interval_beta = quantile(beta_df$log_b0b1, probs = c(0.025, 0.975))

rsq_df =
  bootstrap_results %>% 
  mutate(
    results = map(models, broom::glance)
  ) %>% 
  select(bstrap_number, results) %>% 
  unnest(results)

confidence_interval_rsq = quantile(rsq_df$r.squared, probs = c(0.025, 0.975))

```

```{r plot_estimates, message=FALSE}

  beta_df %>% 
  ggplot(aes(x = log_b0b1)) +
  geom_histogram()

  rsq_df %>% 
  ggplot(aes(x = r.squared)) +
  geom_histogram()

```

The plots of the distributions of the R^2 and log(B0B1) values show that, using 5000 bootstrap samples, the distributions of each parameter are approximately normal, though both distributions are slightly left skewed.

The 95% confidence interval for log(β̂ 0∗β̂1) across 5000 bootstrap samples is (1.965, 2.059). The 95% confidence interval for r2 across 5000 bootstrap samples is (0.894, 0.928)
